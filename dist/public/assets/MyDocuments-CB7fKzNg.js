import{r as l,j as e}from"./ui-vendor-C96WIwkg.js";import{m as K,a as Y,t as f,b as d,B as m,C as D,f as T,c as ee,d as te,e as se,k as S,s as ae,I as ne,F as re,D as le,v as ie,w as ce,x as oe,y as de}from"./index-Bkz6h1fQ.js";import{B as k}from"./badge-DdDRUR73.js";import{T as me,a as ue,b as P,c as x,d as xe,e as h}from"./table-Cq_j4dL4.js";import{T as he,a as pe,b as A}from"./tabs-CacS76o1.js";import{S as ge}from"./skeleton-CH6Aula-.js";import{B as z}from"./bookmark-Dr0RJX4r.js";import{R as je}from"./refresh-cw-X5VGk4GL.js";import{E as fe}from"./eye-D29FSyEF.js";import{D as ve}from"./download-BYvKutrd.js";import{T as Ne}from"./trash-2-Dqtod12U.js";import"./react-vendor-DDxydHEc.js";import"./query-vendor-Dpt6u7bR.js";import"./chart-vendor-8DIN3ZwM.js";const be=200,we=10080*60*1e3,ye=/[^0-9A-Za-z\u0600-\u06FF\s-_]/g,Ce=s=>{if(!s)return"—";try{const n=typeof s=="string"?new Date(s):s;return Number.isNaN(n.getTime())?"—":n.toLocaleDateString("ar-SA",{year:"numeric",month:"short",day:"numeric"})}catch{return"—"}},v=s=>!!(s.isSaved??s.saved),De=s=>s.split(/[-_]/).filter(Boolean).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" "),N=s=>s.title&&s.title.trim().length>0?s.title:s.companyName?`${s.companyName} - ${s.templateCode??"مستند"}`:s.templateCode?De(s.templateCode):`مستند رقم ${s.id}`,Te=(s,n=140)=>{const i=s.outputText||s.content||s.outputHtml||"",r=typeof i=="string"?i.replace(/<[^>]+>/g," ").replace(/\s+/g," "):"";return r?r.length>n?`${r.slice(0,n)}…`:r:"—"},Se=({document:s,open:n,onOpenChange:i})=>e.jsx(le,{open:n,onOpenChange:i,children:e.jsxs(ie,{className:"max-w-3xl",children:[e.jsx(ce,{children:e.jsx(oe,{children:s?N(s):"معاينة المستند"})}),s?e.jsx(de,{className:"max-h-[60vh] rounded-lg border bg-white/50 p-6",children:s.outputHtml?e.jsx("div",{className:"space-y-4 text-right leading-relaxed",dangerouslySetInnerHTML:{__html:s.outputHtml}}):e.jsx("pre",{className:"whitespace-pre-wrap text-sm text-right leading-relaxed",children:s.outputText??s.content??"لا توجد بيانات لعرضها"})}):e.jsx("div",{className:"text-center text-muted-foreground",children:"لا يوجد مستند محدد"})]})});function Ue(){const{isAuthenticated:s}=K(),[,n]=Y(),i=f.useUtils(),r={limit:be},[p,E]=l.useState("all"),[b,U]=l.useState(""),[M,B]=l.useState(null),[L,H]=l.useState(null),[R,F]=l.useState(null),{data:G,isLoading:O,isFetching:I,refetch:Q}=f.documentGenerator.getMyDocuments.useQuery(r,{enabled:s,staleTime:1e3*60*2}),_=G?.documents,u=l.useMemo(()=>_??[],[_]),w=f.documentGenerator.toggleSaveDocument.useMutation({onSuccess:t=>{d.success(t.isSaved?"تم حفظ المستند في المفضلة":"تمت إزالته من المفضلة"),i.documentGenerator.getMyDocuments.invalidate(r)},onError:()=>d.error("تعذر تحديث حالة المستند")}),y=f.documentGenerator.deleteDocument.useMutation({onSuccess:()=>{d.success("تم حذف المستند نهائياً"),i.documentGenerator.getMyDocuments.invalidate(r)},onError:()=>d.error("تعذر حذف المستند")}),$=l.useMemo(()=>{const t=b.trim().toLowerCase();return u.filter(a=>p==="saved"&&!v(a)||p==="draft"&&v(a)?!1:t?`${N(a)} ${a.templateCode??""} ${a.companyName??""}`.toLowerCase().includes(t):!0)},[u,p,b]),j=l.useMemo(()=>{const t=u.length,a=u.filter(v).length,g=t-a,C=u.filter(c=>{if(!c.createdAt)return!1;const o=typeof c.createdAt=="string"?new Date(c.createdAt):c.createdAt;return Date.now()-o.getTime()<=we}).length;return{total:t,saved:a,drafts:g,recent:C}},[u]),W=t=>{H(t),w.mutate({documentId:t},{onSettled:()=>H(null)})},X=t=>{F(t),y.mutate({documentId:t},{onSettled:()=>F(null)})},V=t=>{const a=t.outputHtml||t.outputText||t.content;if(!a){d.info("لا يوجد محتوى قابل للتنزيل لهذا المستند حالياً");return}try{const g=!!t.outputHtml,C=new Blob([a],{type:g?"text/html;charset=utf-8":"text/plain;charset=utf-8"}),c=URL.createObjectURL(C),o=document.createElement("a");o.href=c;const J=N(t).replace(ye,"").trim()||"document";o.download=`${J}-${t.id}.${g?"html":"txt"}`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(c),d.success("تم تجهيز المستند للتحميل")}catch{d.error("حدث خطأ أثناء تجهيز الملف")}},Z=()=>{s&&Q()},q=$.length===0;return e.jsxs("div",{className:"min-h-screen bg-slate-50",children:[e.jsxs("div",{className:"container mx-auto px-4 py-10 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"مكتبتي"}),e.jsx("p",{className:"text-muted-foreground",children:"جميع المستندات التي تم توليدها أو حفظها من الأدوات الذكية."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{variant:"outline",onClick:()=>E("saved"),className:p==="saved"?"border-blue-500 text-blue-600":void 0,children:[e.jsx(z,{className:"h-4 w-4 ml-2"}),"المفضلة"]}),e.jsx(m,{className:"bg-gradient-to-r from-purple-600 to-blue-600",onClick:()=>n("/document-generator"),children:"+ مستند جديد"})]})]}),s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid gap-4 md:grid-cols-4",children:[{label:"إجمالي المستندات",value:j.total},{label:"محفوظ",value:j.saved},{label:"مسودات",value:j.drafts},{label:"آخر 7 أيام",value:j.recent}].map(t=>e.jsx(D,{children:e.jsxs(T,{className:"p-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t.label}),e.jsx("p",{className:"text-2xl font-bold",children:t.value})]})},t.label))}),e.jsxs(D,{children:[e.jsxs(ee,{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx(te,{children:"المحفوظات"}),e.jsx(se,{children:"فلترة، بحث، وتنزيل المستندات"})]}),e.jsxs(m,{variant:"ghost",size:"sm",onClick:Z,disabled:I,children:[I?e.jsx(S,{className:"h-4 w-4 ml-2 animate-spin"}):e.jsx(je,{className:"h-4 w-4 ml-2"}),"تحديث"]})]}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(he,{value:p,onValueChange:t=>E(t),children:e.jsxs(pe,{children:[e.jsx(A,{value:"all",children:"الكل"}),e.jsx(A,{value:"saved",children:"المحفوظة"}),e.jsx(A,{value:"draft",children:"مسودات"})]})}),e.jsxs("div",{className:"flex items-center gap-2 w-full md:w-72",children:[e.jsx(ae,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(ne,{placeholder:"بحث باسم المستند أو الشركة",value:b,onChange:t=>U(t.target.value)})]})]}),O?e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((t,a)=>e.jsx(ge,{className:"h-24 w-full rounded-2xl"},a))}):q?e.jsx("div",{className:"rounded-2xl border border-dashed p-8 text-center text-muted-foreground",children:"لا توجد مستندات مطابقة لخيارات البحث الحالية. قم بتوليد مستند جديد أو عدّل عوامل التصفية."}):e.jsxs(me,{children:[e.jsx(ue,{children:e.jsxs(P,{children:[e.jsx(x,{className:"text-right",children:"العنوان"}),e.jsx(x,{className:"text-right",children:"النوع"}),e.jsx(x,{className:"text-right",children:"اللغة"}),e.jsx(x,{className:"text-right",children:"التاريخ"}),e.jsx(x,{className:"text-right",children:"ملخص"}),e.jsx(x,{className:"text-right",children:"إجراءات"})]})}),e.jsx(xe,{children:$.map(t=>{const a=v(t);return e.jsxs(P,{children:[e.jsx(h,{children:e.jsxs("div",{className:"flex items-center gap-2 font-medium",children:[e.jsx(re,{className:"h-4 w-4 text-purple-600"}),N(t)]})}),e.jsx(h,{children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.templateCode&&e.jsx(k,{variant:"outline",children:t.templateCode}),t.companyName&&e.jsx(k,{variant:"secondary",children:t.companyName})]})}),e.jsx(h,{children:t.lang&&e.jsx(k,{variant:"outline",children:t.lang==="ar"?"العربية":t.lang==="en"?"الإنجليزية":"ثنائي"})}),e.jsx(h,{children:Ce(t.createdAt)}),e.jsx(h,{className:"text-sm text-muted-foreground",children:Te(t)}),e.jsx(h,{children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>B(t),children:[e.jsx(fe,{className:"h-4 w-4 ml-1"}),"عرض"]}),e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>V(t),children:[e.jsx(ve,{className:"h-4 w-4 ml-1"}),"تحميل"]}),e.jsxs(m,{variant:a?"default":"ghost",size:"sm",onClick:()=>W(t.id),disabled:L===t.id&&w.isPending,children:[L===t.id&&w.isPending?e.jsx(S,{className:"h-4 w-4 ml-1 animate-spin"}):e.jsx(z,{className:"h-4 w-4 ml-1",fill:a?"currentColor":"none"}),a?"إزالة":"حفظ"]}),e.jsxs(m,{variant:"ghost",size:"sm",className:"text-red-600",onClick:()=>X(t.id),disabled:R===t.id&&y.isPending,children:[R===t.id&&y.isPending?e.jsx(S,{className:"h-4 w-4 ml-1 animate-spin"}):e.jsx(Ne,{className:"h-4 w-4 ml-1"}),"حذف"]})]})})]},t.id)})})]})]})]})]}):e.jsx(D,{children:e.jsx(T,{className:"py-16 text-center text-muted-foreground",children:"قم بتسجيل الدخول للوصول إلى مكتبة المستندات الخاصة بك."})})]}),e.jsx(Se,{document:M,open:!!M,onOpenChange:t=>{t||B(null)}})]})}export{Ue as default};
