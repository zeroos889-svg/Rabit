{"version":3,"file":"textarea-CDZ7LSXO.js","sources":["../../../client/src/hooks/usePersistFn.ts","../../../client/src/hooks/useComposition.ts","../../../client/src/components/ui/textarea.tsx"],"sourcesContent":["import { useRef } from \"react\";\n\ntype noop = (...args: any[]) => any;\n\n/**\n * usePersistFn 可以替代 useCallback 以降低心智负担\n */\nexport function usePersistFn<T extends noop>(fn: T) {\n  const fnRef = useRef<T>(fn);\n  fnRef.current = fn;\n\n  const persistFn = useRef<T | null>(null);\n  if (!persistFn.current) {\n    persistFn.current = (function (this: unknown, ...args: Parameters<T>) {\n      // Always call the latest fn reference\n      return fnRef.current!.apply(this, args);\n    }) as T;\n  }\n\n  return persistFn.current;\n}\n","import { useRef } from \"react\";\nimport { usePersistFn } from \"./usePersistFn\";\n\nexport interface UseCompositionReturn<\n  T extends HTMLInputElement | HTMLTextAreaElement,\n> {\n  onCompositionStart: React.CompositionEventHandler<T>;\n  onCompositionEnd: React.CompositionEventHandler<T>;\n  onKeyDown: React.KeyboardEventHandler<T>;\n  isComposing: () => boolean;\n}\n\nexport interface UseCompositionOptions<\n  T extends HTMLInputElement | HTMLTextAreaElement,\n> {\n  onKeyDown?: React.KeyboardEventHandler<T>;\n  onCompositionStart?: React.CompositionEventHandler<T>;\n  onCompositionEnd?: React.CompositionEventHandler<T>;\n}\n\ntype TimerResponse = ReturnType<typeof setTimeout>;\n\nexport function useComposition<\n  T extends HTMLInputElement | HTMLTextAreaElement = HTMLInputElement,\n>(options: UseCompositionOptions<T> = {}): UseCompositionReturn<T> {\n  const {\n    onKeyDown: originalOnKeyDown,\n    onCompositionStart: originalOnCompositionStart,\n    onCompositionEnd: originalOnCompositionEnd,\n  } = options;\n\n  const c = useRef(false);\n  const timer = useRef<TimerResponse | null>(null);\n  const timer2 = useRef<TimerResponse | null>(null);\n\n  const onCompositionStart = usePersistFn((e: React.CompositionEvent<T>) => {\n    if (timer.current) {\n      clearTimeout(timer.current);\n      timer.current = null;\n    }\n    if (timer2.current) {\n      clearTimeout(timer2.current);\n      timer2.current = null;\n    }\n    c.current = true;\n    originalOnCompositionStart?.(e);\n  });\n\n  const onCompositionEnd = usePersistFn((e: React.CompositionEvent<T>) => {\n    // 使用两层 setTimeout 来处理 Safari 浏览器中 compositionEnd 先于 onKeyDown 触发的问题\n    timer.current = setTimeout(() => {\n      timer2.current = setTimeout(() => {\n        c.current = false;\n      });\n    });\n    originalOnCompositionEnd?.(e);\n  });\n\n  const onKeyDown = usePersistFn((e: React.KeyboardEvent<T>) => {\n    // 在 composition 状态下，阻止 ESC 和 Enter（非 shift+Enter）事件的冒泡\n    if (\n      c.current &&\n      (e.key === \"Escape\" || (e.key === \"Enter\" && !e.shiftKey))\n    ) {\n      e.stopPropagation();\n      return;\n    }\n    originalOnKeyDown?.(e);\n  });\n\n  const isComposing = usePersistFn(() => {\n    return c.current;\n  });\n\n  return {\n    onCompositionStart,\n    onCompositionEnd,\n    onKeyDown,\n    isComposing,\n  };\n}\n","import { useDialogComposition } from \"@/components/ui/dialog\";\nimport { useComposition } from \"@/hooks/useComposition\";\nimport { cn } from \"@/lib/utils\";\nimport * as React from \"react\";\n\nfunction Textarea({\n  className,\n  onKeyDown,\n  onCompositionStart,\n  onCompositionEnd,\n  ...props\n}: React.ComponentProps<\"textarea\">) {\n  // Get dialog composition context if available (will be no-op if not inside Dialog)\n  const dialogComposition = useDialogComposition();\n\n  // Add composition event handlers to support input method editor (IME) for CJK languages.\n  const {\n    onCompositionStart: handleCompositionStart,\n    onCompositionEnd: handleCompositionEnd,\n    onKeyDown: handleKeyDown,\n  } = useComposition<HTMLTextAreaElement>({\n    onKeyDown: e => {\n      // Check if this is an Enter key that should be blocked\n      const isComposing =\n        (e.nativeEvent as any).isComposing ||\n        dialogComposition.justEndedComposing();\n\n      // If Enter key is pressed while composing or just after composition ended,\n      // don't call the user's onKeyDown (this blocks the business logic)\n      // Note: For textarea, Shift+Enter should still work for newlines\n      if (e.key === \"Enter\" && !e.shiftKey && isComposing) {\n        return;\n      }\n\n      // Otherwise, call the user's onKeyDown\n      onKeyDown?.(e);\n    },\n    onCompositionStart: e => {\n      dialogComposition.setComposing(true);\n      onCompositionStart?.(e);\n    },\n    onCompositionEnd: e => {\n      // Mark that composition just ended - this helps handle the Enter key that confirms input\n      dialogComposition.markCompositionEnd();\n      // Delay setting composing to false to handle Safari's event order\n      // In Safari, compositionEnd fires before the ESC keydown event\n      setTimeout(() => {\n        dialogComposition.setComposing(false);\n      }, 100);\n      onCompositionEnd?.(e);\n    },\n  });\n\n  return (\n    <textarea\n      data-slot=\"textarea\"\n      className={cn(\n        \"border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      onCompositionStart={handleCompositionStart}\n      onCompositionEnd={handleCompositionEnd}\n      onKeyDown={handleKeyDown}\n      {...props}\n    />\n  );\n}\n\nexport { Textarea };\n"],"names":["usePersistFn","fn","fnRef","useRef","persistFn","args","useComposition","options","originalOnKeyDown","originalOnCompositionStart","originalOnCompositionEnd","c","timer","timer2","onCompositionStart","e","onCompositionEnd","onKeyDown","isComposing","Textarea","className","props","dialogComposition","useDialogComposition","handleCompositionStart","handleCompositionEnd","handleKeyDown","jsx","cn"],"mappings":"kGAOO,SAASA,EAA6BC,EAAO,CAClD,MAAMC,EAAQC,EAAAA,OAAUF,CAAE,EAC1BC,EAAM,QAAUD,EAEhB,MAAMG,EAAYD,EAAAA,OAAiB,IAAI,EACvC,OAAKC,EAAU,UACbA,EAAU,SAAW,YAA4BC,EAAqB,CAEpE,OAAOH,EAAM,QAAS,MAAM,KAAMG,CAAI,CACxC,IAGKD,EAAU,OACnB,CCEO,SAASE,EAEdC,EAAoC,GAA6B,CACjE,KAAM,CACJ,UAAWC,EACX,mBAAoBC,EACpB,iBAAkBC,CAAA,EAChBH,EAEEI,EAAIR,EAAAA,OAAO,EAAK,EAChBS,EAAQT,EAAAA,OAA6B,IAAI,EACzCU,EAASV,EAAAA,OAA6B,IAAI,EAE1CW,EAAqBd,EAAce,GAAiC,CACpEH,EAAM,UACR,aAAaA,EAAM,OAAO,EAC1BA,EAAM,QAAU,MAEdC,EAAO,UACT,aAAaA,EAAO,OAAO,EAC3BA,EAAO,QAAU,MAEnBF,EAAE,QAAU,GACZF,IAA6BM,CAAC,CAChC,CAAC,EAEKC,EAAmBhB,EAAce,GAAiC,CAEtEH,EAAM,QAAU,WAAW,IAAM,CAC/BC,EAAO,QAAU,WAAW,IAAM,CAChCF,EAAE,QAAU,EACd,CAAC,CACH,CAAC,EACDD,IAA2BK,CAAC,CAC9B,CAAC,EAEKE,EAAYjB,EAAce,GAA8B,CAE5D,GACEJ,EAAE,UACDI,EAAE,MAAQ,UAAaA,EAAE,MAAQ,SAAW,CAACA,EAAE,UAChD,CACAA,EAAE,gBAAA,EACF,MACF,CACAP,IAAoBO,CAAC,CACvB,CAAC,EAEKG,EAAclB,EAAa,IACxBW,EAAE,OACV,EAED,MAAO,CACL,mBAAAG,EACA,iBAAAE,EACA,UAAAC,EACA,YAAAC,CAAA,CAEJ,CC3EA,SAASC,EAAS,CAChB,UAAAC,EACA,UAAAH,EACA,mBAAAH,EACA,iBAAAE,EACA,GAAGK,CACL,EAAqC,CAEnC,MAAMC,EAAoBC,EAAA,EAGpB,CACJ,mBAAoBC,EACpB,iBAAkBC,EAClB,UAAWC,CAAA,EACTpB,EAAoC,CACtC,UAAWS,GAAK,CAEd,MAAMG,EACHH,EAAE,YAAoB,aACvBO,EAAkB,mBAAA,EAKhBP,EAAE,MAAQ,SAAW,CAACA,EAAE,UAAYG,GAKxCD,IAAYF,CAAC,CACf,EACA,mBAAoBA,GAAK,CACvBO,EAAkB,aAAa,EAAI,EACnCR,IAAqBC,CAAC,CACxB,EACA,iBAAkBA,GAAK,CAErBO,EAAkB,mBAAA,EAGlB,WAAW,IAAM,CACfA,EAAkB,aAAa,EAAK,CACtC,EAAG,GAAG,EACNN,IAAmBD,CAAC,CACtB,CAAA,CACD,EAED,OACEY,EAAAA,IAAC,WAAA,CACC,YAAU,WACV,UAAWC,EACT,scACAR,CAAA,EAEF,mBAAoBI,EACpB,iBAAkBC,EAClB,UAAWC,EACV,GAAGL,CAAA,CAAA,CAGV"}