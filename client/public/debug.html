<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Ø±Ø§Ø¨ÙØ·</title>
    <style>
        body { font-family: Cairo, Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; font-size: 12px; }
        button { background: #3b62ff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #2a4ecc; }
        h1 { color: #3b62ff; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ØªØ´Ø®ÙŠØµ Ø±Ø§Ø¨ÙØ·</h1>
    
    <div class="card">
        <h3>Ø­Ø§Ù„Ø© Service Worker</h3>
        <div id="sw-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</div>
    </div>

    <div class="card">
        <h3>Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø´</h3>
        <div id="cache-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</div>
    </div>

    <div class="card">
        <h3>Ø­Ø§Ù„Ø© API</h3>
        <div id="api-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</div>
    </div>

    <div class="card">
        <h3>Ø­Ø§Ù„Ø© JavaScript</h3>
        <div id="js-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</div>
    </div>

    <div class="card">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­</h3>
        <div id="browser-info"></div>
    </div>

    <div class="card">
        <h3>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h3>
        <button onclick="clearAllCaches()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø´</button>
        <button onclick="unregisterSW()">âŒ Ø¥Ù„ØºØ§Ø¡ Service Worker</button>
        <button onclick="hardReload()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆÙŠØ©</button>
        <button onclick="goToApp()">ğŸ  Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</button>
    </div>

    <div class="card">
        <h3>Ø³Ø¬Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ</h3>
        <pre id="log"></pre>
    </div>

    <script>
        const log = (msg, type = 'info') => {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString('ar-SA');
            logEl.textContent += `[${time}] ${msg}\n`;
            console.log(msg);
        };

        // Browser info
        document.getElementById('browser-info').innerHTML = `
            <p>Ø§Ù„Ù…ØªØµÙØ­: ${navigator.userAgent}</p>
            <p>Ø§Ù„Ù„ØºØ©: ${navigator.language}</p>
            <p>Online: ${navigator.onLine ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„'}</p>
        `;

        // Check Service Worker
        async function checkSW() {
            const statusEl = document.getElementById('sw-status');
            if (!('serviceWorker' in navigator)) {
                statusEl.innerHTML = '<span class="warning">âš ï¸ Service Worker ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</span>';
                return;
            }

            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                if (registrations.length === 0) {
                    statusEl.innerHTML = '<span class="success">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Service Worker Ù…Ø³Ø¬Ù„</span>';
                } else {
                    let html = `<span class="warning">âš ï¸ ÙŠÙˆØ¬Ø¯ ${registrations.length} Service Worker(s):</span><ul>`;
                    for (const reg of registrations) {
                        html += `<li>Scope: ${reg.scope}, State: ${reg.active?.state || 'N/A'}</li>`;
                    }
                    html += '</ul>';
                    statusEl.innerHTML = html;
                }
                log(`Found ${registrations.length} service worker(s)`);
            } catch (err) {
                statusEl.innerHTML = `<span class="error">âŒ Ø®Ø·Ø£: ${err.message}</span>`;
                log(`SW Error: ${err.message}`, 'error');
            }
        }

        // Check Caches
        async function checkCaches() {
            const statusEl = document.getElementById('cache-status');
            try {
                const cacheNames = await caches.keys();
                if (cacheNames.length === 0) {
                    statusEl.innerHTML = '<span class="success">âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ø´ Ù…Ø®Ø²Ù†</span>';
                } else {
                    let html = `<span class="warning">âš ï¸ ÙŠÙˆØ¬Ø¯ ${cacheNames.length} ÙƒØ§Ø´:</span><ul>`;
                    for (const name of cacheNames) {
                        const cache = await caches.open(name);
                        const keys = await cache.keys();
                        html += `<li>${name}: ${keys.length} Ù…Ù„Ù</li>`;
                    }
                    html += '</ul>';
                    statusEl.innerHTML = html;
                }
                log(`Found ${cacheNames.length} cache(s): ${cacheNames.join(', ')}`);
            } catch (err) {
                statusEl.innerHTML = `<span class="error">âŒ Ø®Ø·Ø£: ${err.message}</span>`;
                log(`Cache Error: ${err.message}`, 'error');
            }
        }

        // Check API
        async function checkAPI() {
            const statusEl = document.getElementById('api-status');
            try {
                const healthRes = await fetch('/health');
                const healthData = await healthRes.json();
                
                const trpcRes = await fetch('/api/trpc/auth.me');
                const trpcData = await trpcRes.json();
                
                statusEl.innerHTML = `
                    <p class="success">âœ… Health: ${healthData.status}</p>
                    <p class="success">âœ… tRPC: ÙŠØ¹Ù…Ù„</p>
                `;
                log('API is working correctly');
            } catch (err) {
                statusEl.innerHTML = `<span class="error">âŒ Ø®Ø·Ø£ API: ${err.message}</span>`;
                log(`API Error: ${err.message}`, 'error');
            }
        }

        // Check JS loading
        async function checkJS() {
            const statusEl = document.getElementById('js-status');
            try {
                // Get the current index file
                const htmlRes = await fetch('/');
                const html = await htmlRes.text();
                const match = html.match(/index-([^"]+)\.js/);
                
                if (match) {
                    const jsFile = `index-${match[1]}.js`;
                    const jsRes = await fetch(`/assets/${jsFile}`);
                    
                    if (jsRes.ok) {
                        const jsText = await jsRes.text();
                        const hasNewCode = jsText.includes('rabithr:sw-version');
                        statusEl.innerHTML = `
                            <p class="success">âœ… Ù…Ù„Ù JS: ${jsFile}</p>
                            <p class="${hasNewCode ? 'success' : 'warning'}">${hasNewCode ? 'âœ…' : 'âš ï¸'} ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯: ${hasNewCode ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}</p>
                        `;
                        log(`JS file: ${jsFile}, has new code: ${hasNewCode}`);
                    } else {
                        statusEl.innerHTML = `<span class="error">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ JS: ${jsRes.status}</span>`;
                    }
                } else {
                    statusEl.innerHTML = '<span class="error">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù JS</span>';
                }
            } catch (err) {
                statusEl.innerHTML = `<span class="error">âŒ Ø®Ø·Ø£: ${err.message}</span>`;
                log(`JS Error: ${err.message}`, 'error');
            }
        }

        // Clear all caches
        async function clearAllCaches() {
            log('Clearing all caches...');
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                log(`Cleared ${cacheNames.length} cache(s)`);
                alert(`ØªÙ… Ù…Ø³Ø­ ${cacheNames.length} ÙƒØ§Ø´ Ø¨Ù†Ø¬Ø§Ø­!`);
                checkCaches();
            } catch (err) {
                log(`Error clearing caches: ${err.message}`, 'error');
                alert(`Ø®Ø·Ø£: ${err.message}`);
            }
        }

        // Unregister Service Worker
        async function unregisterSW() {
            log('Unregistering service workers...');
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const reg of registrations) {
                    await reg.unregister();
                }
                log(`Unregistered ${registrations.length} service worker(s)`);
                alert(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ ${registrations.length} Service Worker Ø¨Ù†Ø¬Ø§Ø­!`);
                checkSW();
            } catch (err) {
                log(`Error unregistering SW: ${err.message}`, 'error');
                alert(`Ø®Ø·Ø£: ${err.message}`);
            }
        }

        // Hard reload
        function hardReload() {
            log('Performing hard reload...');
            location.reload(true);
        }

        // Go to app
        function goToApp() {
            window.location.href = '/?debug_cleared=' + Date.now();
        }

        // Run all checks
        log('Starting diagnostics...');
        checkSW();
        checkCaches();
        checkAPI();
        checkJS();
    </script>
</body>
</html>
