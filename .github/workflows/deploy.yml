name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # Pre-deployment Tests (optional)
  # ==========================================
  pre-deploy-tests:
    name: üß™ Pre-deployment Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    timeout-minutes: 15

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üß™ Run tests
        run: npm test

      - name: üèóÔ∏è Build check
        run: npm run build

  # ==========================================
  # Build Docker Image
  # ==========================================
  build-image:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    needs: [pre-deploy-tests]
    if: always() && (needs.pre-deploy-tests.result == 'success' || needs.pre-deploy-tests.result == 'skipped')
    timeout-minutes: 20

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üìù Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=${{ inputs.environment }}-
            type=raw,value=${{ inputs.environment }}-latest

      - name: üèóÔ∏è Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=${{ inputs.environment }}

  # ==========================================
  # Deploy to Railway
  # ==========================================
  deploy-railway:
    name: üöÇ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [build-image]
    if: inputs.environment == 'production' || inputs.environment == 'staging'
    environment:
      name: ${{ inputs.environment }}
      url: https://rabit-hr-${{ inputs.environment }}.railway.app

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: üöÇ Deploy to Railway
        run: |
          npm install -g @railway/cli
          railway up --service backend --environment ${{ inputs.environment }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: ‚è≥ Wait for deployment
        run: sleep 30

      - name: üè• Health check
        run: |
          HEALTH_URL="https://rabit-hr-${{ inputs.environment }}.railway.app/health"
          for i in {1..10}; do
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "‚è≥ Waiting for service to be ready... (attempt $i/10)"
            sleep 10
          done
          echo "‚ùå Health check failed after 10 attempts"
          exit 1

  # ==========================================
  # Deploy to Vercel
  # ==========================================
  deploy-vercel:
    name: ‚ñ≤ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [build-image]
    environment:
      name: ${{ inputs.environment }}-frontend
      url: https://rabit-hr-${{ inputs.environment }}.vercel.app

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: ‚ñ≤ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ inputs.environment == 'production' && '--prod' || '' }}
          working-directory: ./
        continue-on-error: true

  # ==========================================
  # Run Database Migrations
  # ==========================================
  run-migrations:
    name: üóÑÔ∏è Run Database Migrations
    runs-on: ubuntu-latest
    needs: [deploy-railway]
    if: inputs.environment == 'production' || inputs.environment == 'staging'

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üóÑÔ∏è Run migrations
        run: npm run db:push
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

  # ==========================================
  # Post-deployment Tests
  # ==========================================
  post-deploy-tests:
    name: üß™ Post-deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vercel, run-migrations]
    if: always()

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v6

      - name: üè• Smoke tests
        run: |
          echo "Running smoke tests..."
          
          # Test Railway backend
          BACKEND_URL="https://rabit-hr-${{ inputs.environment }}.railway.app"
          if curl -f -s "$BACKEND_URL/health" > /dev/null; then
            echo "‚úÖ Backend health check passed"
          else
            echo "‚ùå Backend health check failed"
          fi
          
          # Test Vercel frontend
          FRONTEND_URL="https://rabit-hr-${{ inputs.environment }}.vercel.app"
          if curl -f -s "$FRONTEND_URL" > /dev/null; then
            echo "‚úÖ Frontend health check passed"
          else
            echo "‚ùå Frontend health check failed"
          fi

  # ==========================================
  # Deployment Summary
  # ==========================================
  deployment-summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-railway, deploy-vercel, run-migrations, post-deploy-tests]
    if: always()

    steps:
      - name: üìä Generate summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Tests**: ${{ inputs.skip_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **Railway Deployment**: ${{ needs.deploy-railway.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Vercel Deployment**: ${{ needs.deploy-vercel.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Database Migrations**: ${{ needs.run-migrations.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Post-deploy Tests**: ${{ needs.post-deploy-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: https://rabit-hr-${{ inputs.environment }}.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: https://rabit-hr-${{ inputs.environment }}.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ Success notification
        if: |
          needs.deploy-railway.result == 'success' &&
          needs.deploy-vercel.result == 'success'
        run: |
          echo "üéâ Deployment to ${{ inputs.environment }} completed successfully!"

      - name: ‚ùå Failure notification
        if: |
          needs.deploy-railway.result == 'failure' ||
          needs.deploy-vercel.result == 'failure'
        run: |
          echo "‚ö†Ô∏è Deployment to ${{ inputs.environment }} encountered issues!"
          exit 1
